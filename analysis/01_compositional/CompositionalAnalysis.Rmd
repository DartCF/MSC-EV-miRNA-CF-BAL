---
title: "Compositional Analysis of miRNA in hMSC EVs"
author: "DartCF Bioinformatics Core"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
params:
  output_dir: !r here::here("results", "01_compositional")
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6)
```

# Overview
<!-- ==============================================================================
Compositional Analysis of miRNA in hMSC EVs
==============================================================================
This analysis focuses on the compositional structure of miRNA reads in 
extracellular vesicles from human mesenchymal stem cells (hMSCs). The goal 
is to understand the fractional abundance of miRNAs, focusing on those that 
individually account for ≥1% of total reads.

INPUTS:
  - data/raw/GSE282919_VLP00436_miRNA_P33_21NOV2019_QC_and_Processed_Data.xlsx
  - data/metadata/sample_metadata.csv

OUTPUTS:
  - results/01_compositional/major_miRNAs_1pct_summary.csv
  - results/01_compositional/major_miRNAs_fractional_abundances.csv
  - results/01_compositional/all_miRNA_fractional_abundances.csv
  - results/01_compositional/major_miRNAs_ANOVA_results.csv
  - results/01_compositional/major_miRNAs_posthoc_comparisons.csv
  - results/01_compositional/major_miRNAs_treatment_summary.csv
  - results/01_compositional/KS_test_results.csv
  - results/01_compositional/diversity_metrics_by_sample.csv
  - results/01_compositional/diversity_summary_by_treatment.csv
  - results/01_compositional/diversity_ANOVA_results.csv
  - results/01_compositional/*.png (figures)
  - results/01_compositional/*.pdf (figures)
============================================================================== -->

---

# 1. Load Required Libraries

```{r libraries}
library(here)
library(readxl)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(scales)

# Set theme for all plots
theme_set(theme_bw(base_size = 12))

# Create output directory
output_dir <- params$output_dir
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

# Helper function to save figures in both PNG and PDF formats
save_figure <- function(plot, filename, width = 10, height = 8) {
  ggsave(file.path(output_dir, paste0(filename, ".png")), plot, 
         width = width, height = height, dpi = 300)
  ggsave(file.path(output_dir, paste0(filename, ".pdf")), plot, 
         width = width, height = height)
  cat("Saved:", filename, ".png/.pdf\n")
}
```

# 2. Load and Prepare Data
```{r load_data}
# Load preprocessed count data (created by 00_download_and_preprocess.R)
counts_file <- here("data", "processed", "mirna_counts_filtered.csv")
metadata_file <- here("data", "metadata", "sample_metadata.csv")

if (!file.exists(counts_file)) {
  stop("Preprocessed counts not found. Run 00_download_and_preprocess.R first.")
}

# Load data
count_data <- read_csv(counts_file, show_col_types = FALSE)
sample_metadata <- read_csv(metadata_file, show_col_types = FALSE)

# Convert to matrix with Gene_ID as rownames
raw_counts <- as.data.frame(count_data[, -1])  # remove Gene_ID column
rownames(raw_counts) <- count_data$Gene_ID

# Create sample mapping for compatibility with downstream code
sample_mapping <- sample_metadata %>%
  dplyr::select(Sample, Treatment_Group) %>%
  as.data.frame()
rownames(sample_mapping) <- sample_mapping$Sample
names(sample_mapping)[names(sample_mapping) == "Treatment_Group"] <- "comparison_7"

# Define sample groups for analysis
analysis_groups <- c("CF_Asp_Neg", "HC", "UNSTIM") 
samples_to_analyze <- sample_metadata %>%
  dplyr::filter(Treatment_Group %in% analysis_groups) %>%
  pull(Sample)

# Filter to samples in analysis
samples_to_analyze <- intersect(samples_to_analyze, colnames(raw_counts))

cat("Total samples in count data:", ncol(raw_counts), "\n")
cat("Total samples for analysis:", length(samples_to_analyze), "\n")
cat("Groups included:", paste(analysis_groups, collapse = ", "), "\n")
```

---

# 3. Calculate Fractional Abundances
```{r calculate_fractions}
# Extract counts for selected samples
raw_counts_subset <- raw_counts[, samples_to_analyze]

# Ensure numeric
raw_counts_subset <- as.data.frame(lapply(raw_counts_subset, as.numeric))
rownames(raw_counts_subset) <- rownames(raw_counts)

# Calculate total reads per sample
sample_totals <- colSums(raw_counts_subset, na.rm = TRUE)

# Calculate fractional abundance (each sample sums to 1)
frac_abundance <- sweep(raw_counts_subset, 2, sample_totals, FUN = "/")

# Verify all samples sum to 1
cat("\nVerification - all samples sum to 1.0:\n")
print(summary(colSums(frac_abundance)))

cat("\nTotal miRNAs detected:", nrow(frac_abundance), "\n")
cat("Total reads across all samples:", format(sum(sample_totals), big.mark = ","), "\n")
```

This replaces everything from the start of section 2 through the end of section 3. The key changes:

1. Reads from `data/processed/mirna_counts_filtered.csv` instead of raw GEO Excel
2. Removes the complex Excel parsing logic
3. Uses the preprocessed data that already has correct sample IDs
4. Keeps the same variable names (`frac_abundance`, `sample_mapping`, `raw_counts`) so downstream code works unchanged

After making this change, re-render the Rmd and check if the ANOVA p-values now match.

# 4. Identify Major miRNAs (≥1% Average Abundance)

```{r identify_major_mirnas}
# Calculate mean fractional abundance across all samples
mean_frac_abundance <- rowMeans(frac_abundance)

# Define threshold (1% = 0.01 fractional abundance)
threshold_pct <- 1
threshold_fraction <- threshold_pct / 100

# Identify miRNAs meeting the threshold
major_mirnas <- mean_frac_abundance[mean_frac_abundance >= threshold_fraction]
major_mirnas_sorted <- sort(major_mirnas, decreasing = TRUE)
major_mirna_names <- names(major_mirnas_sorted)

# Create detailed summary table
major_mirnas_table <- data.frame(
  Rank = 1:length(major_mirnas_sorted),
  miRNA = major_mirna_names,
  Mean_Fraction = major_mirnas_sorted,
  Percentage = major_mirnas_sorted * 100,
  Cumulative_Percentage = cumsum(major_mirnas_sorted) * 100
)

cat("\n=== Major miRNAs (≥1% of Total Reads) ===\n\n")
print(major_mirnas_table, row.names = FALSE, digits = 4)

# Summary statistics
total_major_fraction <- sum(major_mirnas_sorted)
remaining_fraction <- 1 - total_major_fraction
n_major <- length(major_mirnas_sorted)
n_total <- nrow(frac_abundance)

cat("\n=== Summary Statistics ===\n")
cat("Number of miRNAs with ≥1% abundance:", n_major, "\n")
cat("These", n_major, "miRNAs collectively represent:", 
    sprintf("%.2f%%", total_major_fraction * 100), "of all reads\n")
cat("Remaining", n_total - n_major, "miRNAs represent:", 
    sprintf("%.2f%%", remaining_fraction * 100), "of all reads\n")
cat("Concentration ratio (Major / Remaining):", 
    sprintf("%.2f", total_major_fraction / remaining_fraction), "\n")
cat("\nMost abundant:", major_mirna_names[1], 
    "at", sprintf("%.2f%%", major_mirnas_sorted[1] * 100), "\n")
cat("Least abundant (of major):", major_mirna_names[n_major], 
    "at", sprintf("%.2f%%", major_mirnas_sorted[n_major] * 100), "\n")

# Save summary table
write.csv(major_mirnas_table, file.path(output_dir, "major_miRNAs_1pct_summary.csv"), 
          row.names = FALSE)
```

---

# 5. Visualizations of Major miRNAs

## 5.1 Bar Plot: Mean Fractional Abundance

```{r barplot_major}
# Calculate appropriate figure height based on number of miRNAs
fig_height <- max(6, n_major * 0.35)

# Prepare data for plotting
major_plot_data <- major_mirnas_table %>%
  mutate(miRNA = factor(miRNA, levels = rev(major_mirna_names))) # Reverse for top-down display

# Create bar plot
p1 <- ggplot(major_plot_data, aes(x = miRNA, y = Percentage)) +
  geom_bar(stat = "identity", fill = "steelblue", alpha = 0.8) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red", size = 0.8) +
  geom_text(aes(label = sprintf("%.2f%%", Percentage)), 
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(
    x = "miRNA",
    y = "Mean Fractional Abundance (%)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(face = "bold")
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))

print(p1)
save_figure(p1, "major_miRNAs_barplot", width = 10, height = fig_height)
```

## 5.2 Cumulative Abundance Plot

```{r cumulative_plot, fig.width=10, fig.height=6}
# Rank all miRNAs by abundance
all_ranked <- data.frame(
  miRNA = names(mean_frac_abundance),
  Mean_Fraction = mean_frac_abundance
) %>%
  arrange(desc(Mean_Fraction)) %>%
  mutate(
    Rank = 1:n(),
    Cumulative_Fraction = cumsum(Mean_Fraction),
    Cumulative_Percentage = Cumulative_Fraction * 100,
    Category = ifelse(Rank <= n_major, "Major (≥1%)", "Others")
  )

# Create cumulative plot
p2 <- ggplot(all_ranked, aes(x = Rank, y = Cumulative_Percentage)) +
  geom_line(size = 1.2, color = "darkblue") +
  geom_point(data = all_ranked[all_ranked$Rank <= n_major, ], 
             aes(x = Rank, y = Cumulative_Percentage),
             color = "red", size = 3) +
  geom_hline(yintercept = total_major_fraction * 100, 
             linetype = "dashed", color = "red", size = 0.8) +
  geom_vline(xintercept = n_major, linetype = "dashed", color = "gray50", size = 0.8) +
  annotate("text", x = n_major, y = 5, 
           label = paste("Top", n_major), color = "red", fontface = "bold", hjust = -0.1) +
  annotate("text", x = 200, y = total_major_fraction * 100 + 5,
           label = sprintf("%.1f%%", total_major_fraction * 100),
           color = "red", fontface = "bold") +
  labs(
    title = "Cumulative Fractional Abundance of miRNAs",
    subtitle = paste("Red points indicate major miRNAs (≥1% average abundance)"),
    x = "miRNA Rank (by abundance)",
    y = "Cumulative Percentage (%)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14)
  ) +
  scale_x_continuous(breaks = c(1, n_major, 50, 100, 200, 400, 600)) +
  scale_y_continuous(breaks = seq(0, 100, 10))

print(p2)
save_figure(p2, "cumulative_abundance_plot", width = 10, height = 6)
```

## 5.3 Stacked Bar Composition

```{r stacked_bar, fig.width=10, fig.height=6}
# Create simplified composition data
composition_data <- data.frame(
  Sample = "All Samples Combined",
  Major = total_major_fraction * 100,
  Others = remaining_fraction * 100
) %>%
  pivot_longer(cols = c(Major, Others), 
               names_to = "Category", 
               values_to = "Percentage")

# Create stacked bar
p3 <- ggplot(composition_data, aes(x = Sample, y = Percentage, fill = Category)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)),
            position = position_stack(vjust = 0.5),
            size = 6, fontface = "bold", color = "white") +
  scale_fill_manual(
    values = c("Major" = "steelblue", "Others" = "gray70"),
    labels = c("Major" = paste("Major miRNAs (≥1%, n =", n_major, ")"), 
               "Others" = "All Other miRNAs")
  ) +
  labs(
    title = "Compositional Dominance of Major miRNAs",
    y = "Percentage of Total Reads (%)",
    x = NULL,
    fill = "Category"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    axis.text.x = element_blank()
  ) +
  scale_y_continuous(breaks = seq(0, 100, 10))

print(p3)
save_figure(p3, "composition_stacked_bar", width = 10, height = 6)
```

---

# 6. Sample-Level Variation in Major miRNAs

## 6.1 Heatmap Across Samples

```{r heatmap_major}
# Calculate appropriate figure height based on number of miRNAs
fig_height <- max(6, n_major * 0.4)

# Extract major miRNA data for all samples
major_data <- frac_abundance[major_mirna_names, ] * 100 # Convert to percentage

# Add treatment group information
sample_groups <- sample_mapping[colnames(major_data), "comparison_7"]

# Prepare data for heatmap
heatmap_data <- major_data %>%
  as.data.frame() %>%
  mutate(miRNA = rownames(.)) %>%
  pivot_longer(cols = -miRNA, names_to = "Sample", values_to = "Percentage") %>%
  mutate(
    miRNA = factor(miRNA, levels = major_mirna_names),
    Group = sample_mapping[Sample, "comparison_7"]
  )

# Create heatmap
p4 <- ggplot(heatmap_data, aes(x = Sample, y = miRNA, fill = Percentage)) +
  geom_tile(color = "white", size = 0.5) +
  scale_fill_gradient2(
    low = "white", 
    mid = "lightblue", 
    high = "darkblue",
    midpoint = median(heatmap_data$Percentage),
    name = "Abundance\n(%)"
  ) +
  labs(
    title = "Fractional Abundance of Major miRNAs Across Samples",
    subtitle = "miRNAs with ≥1% average abundance",
    x = "Sample",
    y = "miRNA"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 6),
    axis.text.y = element_text(face = "bold"),
    legend.position = "right"
  ) +
  facet_grid(. ~ Group, scales = "free_x", space = "free_x")

print(p4)
save_figure(p4, "major_miRNAs_heatmap_by_sample", width = 14, height = fig_height)
```

## 6.2 Boxplots by Treatment Group

```{r boxplot_groups}
# Calculate appropriate figure height based on number of miRNAs
fig_height <- max(6, n_major * 0.6)

# Create boxplot for each miRNA across treatment groups
p5 <- ggplot(heatmap_data, aes(x = Group, y = Percentage, fill = Group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 1.5) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  facet_wrap(~ miRNA, scales = "free_y", ncol = 5) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Distribution of Major miRNA Abundances by Treatment Group",
    subtitle = "miRNAs with ≥1% average abundance",
    x = "Treatment Group",
    y = "Fractional Abundance (%)"
  ) +
  theme_bw(base_size = 10) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"
  )

print(p5)
save_figure(p5, "major_miRNAs_boxplot_by_group", width = 12, height = fig_height)
```

## 6.3 Statistical Testing: Treatment Group Differences

Testing whether mean abundance of major miRNAs differs significantly between treatment groups using one-way ANOVA with post-hoc pairwise comparisons.

```{r anova_major_mirnas}
# Prepare data for statistical testing
test_data <- frac_abundance[major_mirna_names, ] %>%
  as.data.frame() %>%
  mutate(miRNA = rownames(.)) %>%
  pivot_longer(cols = -miRNA, names_to = "sample", values_to = "fraction") %>%
  mutate(
    treatment = sample_mapping[sample, "comparison_7"],
    percentage = fraction * 100  # Convert to percentage for easier interpretation
  )

# Function to perform ANOVA and Tukey HSD for each miRNA
perform_anova_tests <- function(mirna_name, data) {
  mirna_data <- data %>% filter(miRNA == mirna_name)
  
  # Perform one-way ANOVA
  anova_result <- aov(percentage ~ treatment, data = mirna_data)
  anova_summary <- summary(anova_result)
  
  # Extract p-value
  anova_pval <- anova_summary[[1]][["Pr(>F)"]][1]
  
  # Perform Tukey HSD post-hoc test if ANOVA is significant
  if(anova_pval < 0.05) {
    tukey_result <- TukeyHSD(anova_result)
    tukey_comparisons <- as.data.frame(tukey_result$treatment)
    tukey_comparisons$comparison <- rownames(tukey_comparisons)
    tukey_comparisons$miRNA <- mirna_name
  } else {
    tukey_comparisons <- NULL
  }
  
  # Calculate mean abundance per treatment
  treatment_means <- mirna_data %>%
    group_by(treatment) %>%
    summarise(mean_pct = mean(percentage), 
              sd_pct = sd(percentage),
              n = n(),
              .groups = 'drop')
  
  return(list(
    miRNA = mirna_name,
    anova_pval = anova_pval,
    tukey_comparisons = tukey_comparisons,
    treatment_means = treatment_means
  ))
}

# Run ANOVA tests for all major miRNAs
anova_results <- lapply(major_mirna_names, perform_anova_tests, data = test_data)

# Create summary table of ANOVA results
anova_summary_table <- data.frame(
  miRNA = sapply(anova_results, function(x) x$miRNA),
  ANOVA_P_Value = sapply(anova_results, function(x) x$anova_pval),
  Significant = sapply(anova_results, function(x) ifelse(x$anova_pval < 0.05, "Yes", "No"))
)

# Adjust for multiple testing using BH correction
anova_summary_table$BH_Adjusted_P <- p.adjust(anova_summary_table$ANOVA_P_Value, 
                                                       method = "BH")
anova_summary_table$Significant_After_Correction <- ifelse(
  anova_summary_table$BH_Adjusted_P < 0.05, "Yes", "No"
)

# Sort by p-value
anova_summary_table <- anova_summary_table %>% arrange(ANOVA_P_Value)

cat("\n=== ANOVA Results for Major miRNAs ===\n")
cat("Testing for differences in mean abundance between treatment groups\n")
cat("(UNSTIM vs HC vs CF)\n\n")
print(anova_summary_table, row.names = FALSE, digits = 4)

# Count significant results
n_sig_raw <- sum(anova_summary_table$ANOVA_P_Value < 0.05)
n_sig_corrected <- sum(anova_summary_table$BH_Adjusted_P < 0.05)

cat("\n=== Summary ===\n")
cat("Total miRNAs tested:", n_major, "\n")
cat("Significant at α = 0.05 (uncorrected):", n_sig_raw, "\n")
cat("Significant after BH correction:", n_sig_corrected, "\n")

# Save ANOVA results
write.csv(anova_summary_table, file.path(output_dir, "major_miRNAs_ANOVA_results.csv"), 
          row.names = FALSE)

# Extract and display post-hoc comparisons for significant miRNAs
if(n_sig_raw > 0) {
  cat("\n=== Post-hoc Pairwise Comparisons (Tukey HSD) ===\n")
  cat("For miRNAs with significant ANOVA results (p < 0.05)\n\n")
  
  significant_mirnas <- anova_summary_table$miRNA[anova_summary_table$ANOVA_P_Value < 0.05]
  
  posthoc_results <- data.frame()
  for(mirna in significant_mirnas) {
    result <- anova_results[[which(sapply(anova_results, function(x) x$miRNA) == mirna)]]
    if(!is.null(result$tukey_comparisons)) {
      tukey_df <- result$tukey_comparisons %>%
        dplyr::select(miRNA, comparison, diff, `p adj`) %>%
        mutate(
          Significant = ifelse(`p adj` < 0.05, "Yes", "No")
        )
      posthoc_results <- rbind(posthoc_results, tukey_df)
    }
  }
  
  if(nrow(posthoc_results) > 0) {
    colnames(posthoc_results) <- c("miRNA", "Comparison", "Mean_Difference", 
                                     "Tukey_P_Value", "Significant")
    print(posthoc_results, row.names = FALSE, digits = 4)
    write.csv(posthoc_results, file.path(output_dir, "major_miRNAs_posthoc_comparisons.csv"), 
              row.names = FALSE)
  }
  
  # Create a summary of treatment means for significant miRNAs
  cat("\n=== Mean Abundances by Treatment (Significant miRNAs Only) ===\n\n")
  for(mirna in significant_mirnas) {
    result <- anova_results[[which(sapply(anova_results, function(x) x$miRNA) == mirna)]]
    cat(mirna, ":\n")
    print(result$treatment_means, row.names = FALSE, digits = 3)
    cat("\n")
  }
} else {
  cat("\nNo miRNAs showed significant differences between treatment groups at α = 0.05\n")
}
```

## 6.4 Visualization of Significant Differences

```{r plot_significant, fig.width=12, fig.height=max(4, n_sig_raw*1.5)}
if(n_sig_raw > 0) {
  # Get list of significant miRNAs
  significant_mirnas <- anova_summary_table$miRNA[anova_summary_table$ANOVA_P_Value < 0.05]
  
  # Filter data for significant miRNAs only
  sig_plot_data <- test_data %>%
    filter(miRNA %in% significant_mirnas) %>%
    mutate(
      miRNA = factor(miRNA, levels = significant_mirnas),
      treatment = factor(treatment, levels = c("UNSTIM", "HC", "CF_Asp_Neg"),
                         labels = c("UNSTIM", "HC", "CF"))
    )
  
  # Prepare annotation data from Tukey HSD results
  # Include both significant (p < 0.05) AND borderline (p < 0.10) comparisons
  annotation_data <- data.frame()
  
  for(mirna in significant_mirnas) {
    result <- anova_results[[which(sapply(anova_results, function(x) x$miRNA) == mirna)]]
    
    if(!is.null(result$tukey_comparisons)) {
      tukey_df <- result$tukey_comparisons
      max_val <- max(sig_plot_data$percentage[sig_plot_data$miRNA == mirna])
      comparisons <- tukey_df$comparison
      p_values <- tukey_df$`p adj`
      
      for(i in 1:length(comparisons)) {
        # Include comparisons with p < 0.10 (captures borderline significance)
        if(p_values[i] < 0.10) {
          comp <- comparisons[i]
          groups <- strsplit(comp, "-")[[1]]
          groups <- recode(groups, "CF_Asp_Neg" = "CF")
          
          # Format exact p-value for display
          if(p_values[i] < 0.001) {
            sig_label <- sprintf("p < 0.001")
          } else {
            sig_label <- sprintf("p = %.3f", p_values[i])
          }
          
          annotation_data <- rbind(annotation_data, data.frame(
            miRNA = mirna,
            comparison = comp,
            group1 = groups[1],
            group2 = groups[2],
            p_value = p_values[i],
            label = sig_label,
            y_position = max_val,
            is_borderline = p_values[i] >= 0.05,  # Flag borderline results
            stringsAsFactors = FALSE
          ))
        }
      }
    }
  }
  
  # Create base plot
  p_sig <- ggplot(sig_plot_data, aes(x = treatment, y = percentage, fill = treatment)) +
    geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 1.5) +
    geom_jitter(width = 0.2, alpha = 0.4, size = 1.5) +
    stat_summary(fun = mean, geom = "point", shape = 23, size = 3, 
                 fill = "red", color = "darkred") +
    facet_wrap(~ miRNA, scales = "free_y", ncol = 4) +
    scale_fill_brewer(palette = "Set2") +
    labs(
      x = "",
      y = "Fractional Abundance (%)"
    ) +
    theme_bw(base_size = 11) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text = element_text(face = "bold", size = 10),
      strip.background = element_rect(fill = "grey95"),
      legend.position = "none"
    )
  
  # Add significance annotations if any exist
  if(nrow(annotation_data) > 0) {
    annotation_data_positioned <- annotation_data %>%
      group_by(miRNA) %>%
      mutate(
        max_y = max(sig_plot_data$percentage[sig_plot_data$miRNA == miRNA]),
        bracket_y = max_y + (max_y * 0.10 * row_number())  # Increased spacing for p-value text
      ) %>%
      ungroup()
    
    treatment_positions <- c("UNSTIM" = 1, "HC" = 2, "CF" = 3)
    
    annotation_data_positioned$x1 <- treatment_positions[annotation_data_positioned$group1]
    annotation_data_positioned$x2 <- treatment_positions[annotation_data_positioned$group2]
    annotation_data_positioned$x_mid <- (annotation_data_positioned$x1 + 
                                         annotation_data_positioned$x2) / 2
    
    # Use different line styles: solid for significant, dashed for borderline
    p_sig <- p_sig +
      # Vertical segments (left)
      geom_segment(data = annotation_data_positioned,
                   aes(x = x1, xend = x1, y = bracket_y, yend = bracket_y * 1.02,
                       linetype = is_borderline),
                   inherit.aes = FALSE, color = "black", show.legend = FALSE) +
      # Horizontal segments
      geom_segment(data = annotation_data_positioned,
                   aes(x = x1, xend = x2, y = bracket_y * 1.02, yend = bracket_y * 1.02,
                       linetype = is_borderline),
                   inherit.aes = FALSE, color = "black", show.legend = FALSE) +
      # Vertical segments (right)
      geom_segment(data = annotation_data_positioned,
                   aes(x = x2, xend = x2, y = bracket_y * 1.02, yend = bracket_y,
                       linetype = is_borderline),
                   inherit.aes = FALSE, color = "black", show.legend = FALSE) +
      # P-value labels
      geom_text(data = annotation_data_positioned,
                aes(x = x_mid, y = bracket_y * 1.05, label = label,
                    fontface = ifelse(is_borderline, "italic", "plain")),
                inherit.aes = FALSE, size = 3) +
      scale_linetype_manual(values = c("FALSE" = "solid", "TRUE" = "dashed"))
  }
  
  print(p_sig)
  save_figure(p_sig, "major_miRNAs_significant_differences", 
              width = 12, height = max(6, n_sig_raw*1.5))
  
  # Print exact p-values to console for reference
  cat("\n=== Exact p-values shown in Figure 3 ===\n")
  cat("(Solid lines = p < 0.05; Dashed lines = 0.05 ≤ p < 0.10)\n\n")
  if(nrow(annotation_data) > 0) {
    for(i in 1:nrow(annotation_data)) {
      status <- ifelse(annotation_data$is_borderline[i], "(borderline)", "(significant)")
      cat(sprintf("%s: %s vs %s, p = %.4f %s\n", 
                  annotation_data$miRNA[i],
                  annotation_data$group1[i],
                  annotation_data$group2[i],
                  annotation_data$p_value[i],
                  status))
    }
  }
  
} else {
  cat("No significant differences detected; skipping visualization.\n")
}
```

## 6.5 Summary Table: Mean Abundance by Treatment

```{r summary_table_by_treatment}
# Create comprehensive summary table
summary_by_treatment <- test_data %>%
  group_by(miRNA, treatment) %>%
  summarise(
    Mean_Percentage = mean(percentage),
    SD = sd(percentage),
    N = n(),
    SE = sd(percentage) / sqrt(n()),
    .groups = 'drop'
  ) %>%
  pivot_wider(
    names_from = treatment,
    values_from = c(Mean_Percentage, SD, SE),
    names_glue = "{treatment}_{.value}"
  ) %>%
  left_join(
    anova_summary_table %>% dplyr::select(miRNA, ANOVA_P_Value, BH_Adjusted_P),
    by = "miRNA"
  ) %>%
  arrange(ANOVA_P_Value)

cat("\n=== Mean Abundance by Treatment Group ===\n")
print(summary_by_treatment, digits = 3)

write.csv(summary_by_treatment, file.path(output_dir, "major_miRNAs_treatment_summary.csv"), 
          row.names = FALSE)
cat("\nComprehensive summary saved to: major_miRNAs_treatment_summary.csv\n")
```

## 6.6 Stacked Bar Plot by Sample and Treatment

This visualization shows the compositional breakdown for each individual sample, allowing you to see both within-group consistency and between-group differences.

```{r stacked_bars_by_sample, fig.width=14, fig.height=8}
# Prepare data for stacked bar chart
stack_data <- frac_abundance %>%
  as.data.frame() %>%
  mutate(miRNA = rownames(.)) %>%
  pivot_longer(cols = -miRNA, names_to = "sample", values_to = "fraction") %>%
  mutate(
    miRNA_category = ifelse(miRNA %in% major_mirna_names, miRNA, "Other"),
    treatment = sample_mapping[sample, "comparison_7"],
    # Relabel CF_Asp_Neg to CF
    treatment = recode(treatment, "CF_Asp_Neg" = "CF")
  ) %>%
  group_by(sample, treatment, miRNA_category) %>%
  summarise(total_fraction = sum(fraction), .groups = 'drop')

# Set factor levels: most abundant at bottom, "Other" at top
stack_data <- stack_data %>%
  mutate(
    miRNA_category = factor(miRNA_category, 
                           levels = rev(c(major_mirna_names, "Other"))),
    treatment = factor(treatment, levels = c("UNSTIM", "HC", "CF"))
  )

# Create color palette: colors for major miRNAs + grey for "Other"
n_colors <- min(n_major, 12)
if (n_major <= 12) {
  stack_colors <- rev(c(brewer.pal(n_major, "Paired"), "grey80"))
} else {
  base_colors <- brewer.pal(12, "Paired")
  stack_colors <- rev(c(rep(base_colors, ceiling(n_major/12))[1:n_major], "grey80"))
}
names(stack_colors) <- rev(c(major_mirna_names, "Other"))

# ---------------------------------------------------------------------------
# Figure 1 (official): Dan's version with simplified labels and larger fonts
# ---------------------------------------------------------------------------
# Create sample number labels (remove "sample" prefix, show only numbers)
stack_data_fig1 <- stack_data %>%
  mutate(
    sample_num = gsub("[^0-9]", "", sample)  # Extract numeric portion only
  )

p6_fig1 <- ggplot(stack_data_fig1, aes(x = sample_num, y = total_fraction, fill = miRNA_category)) +
  geom_bar(stat = "identity", width = 0.8) +
  scale_fill_manual(values = stack_colors, name = "miRNA") +
  facet_wrap(~ treatment, scales = "free_x", nrow = 1) +
  labs(
    x = "Sample Number",
    y = "Fractional Abundance"
  ) +
  theme_classic(base_size = 14) +  # Increased from 12
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12),  # Increased
    axis.text.y = element_text(size = 12),  # Added
    axis.title = element_text(size = 14, face = "bold"),  # Added
    strip.text = element_text(size = 14, face = "bold"),  # Increased from 11
    strip.background = element_rect(fill = "grey95", color = "grey50"),
    legend.position = "bottom",
    legend.text = element_text(size = 11, family = "mono"),  # Increased from 9
    legend.title = element_text(size = 12, face = "bold")  # Added
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE, reverse = TRUE))

print(p6_fig1)
save_figure(p6_fig1, "major_miRNAs_stacked_by_sample", width = 14, height = 8)

# ---------------------------------------------------------------------------
# Alternative version: Original with full sample names (archived)
# ---------------------------------------------------------------------------
p6_original <- ggplot(stack_data, aes(x = sample, y = total_fraction, fill = miRNA_category)) +
  geom_bar(stat = "identity", width = 0.8) +
  scale_fill_manual(values = stack_colors, name = "miRNA") +
  facet_wrap(~ treatment, scales = "free_x", nrow = 1) +
  labs(
    x = "",
    y = "Fractional Abundance"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 11),
    strip.text = element_text(size = 11, face = "bold"),
    strip.background = element_rect(fill = "grey95", color = "grey50"),
    legend.position = "bottom",
    legend.text = element_text(size = 9, family = "mono")
  ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE, reverse = TRUE))

# Save original version with different filename (not overwriting Fig 1)
save_figure(p6_original, "major_miRNAs_stacked_by_sample_full_labels", width = 14, height = 8)
```

---

# 7. Compositional Differences Between Treatment Groups

The three treatment groups show significantly different cumulative distribution functions, indicating that exposure conditions alter the compositional structure of miRNA cargo in extracellular vesicles.

## 7.1 Statistical Testing: Kolmogorov-Smirnov Tests

```{r ks_tests}
# Prepare data for statistical testing
abundance_by_treatment <- frac_abundance %>%
  as.data.frame() %>%
  mutate(miRNA = rownames(.)) %>%
  pivot_longer(cols = -miRNA, names_to = "sample", values_to = "fraction") %>%
  mutate(treatment = sample_mapping[sample, "comparison_7"]) %>%
  group_by(treatment, miRNA) %>%
  summarise(mean_fraction = mean(fraction, na.rm = TRUE), .groups = 'drop') %>%
  group_by(treatment) %>%
  arrange(desc(mean_fraction)) %>%
  mutate(
    rank = row_number(),
    cumsum_fraction = cumsum(mean_fraction),
    total_fraction = sum(mean_fraction),
    cumsum_pct = cumsum_fraction / total_fraction * 100,
    log10_fraction = log10(mean_fraction + 1e-8)  # Add small constant to avoid log(0)
  ) %>%
  ungroup()

# Perform pairwise Kolmogorov-Smirnov tests
treatments <- c("UNSTIM", "HC", "CF_Asp_Neg")
ks_results <- data.frame()

for(i in 1:(length(treatments)-1)) {
  for(j in (i+1):length(treatments)) {
    treat1 <- treatments[i]
    treat2 <- treatments[j]
    
    data1 <- abundance_by_treatment %>% 
      filter(treatment == treat1) %>% 
      pull(mean_fraction)
    data2 <- abundance_by_treatment %>% 
      filter(treatment == treat2) %>% 
      pull(mean_fraction)
    
    ks_test <- ks.test(data1, data2)
    
    ks_results <- rbind(ks_results, data.frame(
      Comparison = paste(treat1, "vs", treat2),
      KS_Statistic = round(as.numeric(ks_test$statistic), 4),
      P_Value = formatC(ks_test$p.value, format = "e", digits = 3),
      Significant = ifelse(ks_test$p.value < 0.05, "Yes", "No")
    ))
  }
}

cat("\n=== Kolmogorov-Smirnov Test Results ===\n")
cat("Tests whether miRNA abundance distributions differ between treatment groups\n\n")
print(ks_results, row.names = FALSE)

# Save results
write.csv(ks_results, file.path(output_dir, "KS_test_results.csv"), row.names = FALSE)

cat("\n\nInterpretation:\n")
cat("All pairwise comparisons show significant distributional differences (p < 0.05).\n")
cat("This indicates that exposure to CF BAL, HC BAL, or no exposure (UNSTIM)\n")
cat("results in fundamentally different compositional structures of miRNA cargo.\n")
```

## 7.2 Density Plots: Visualizing Distributional Shapes

These plots reveal that HC (healthy control BAL) has a much broader distributional tail compared to UNSTIM and CF_Asp_Neg, suggesting greater compositional diversity or evenness. CF_Asp_Neg appears compositionally more similar to UNSTIM than to HC.

```{r density_plots, fig.width=8, fig.height=10}
# Set factor levels for desired order: UNSTIM (top), HC (middle), CF_Asp_Neg (bottom)
abundance_by_treatment <- abundance_by_treatment %>%
  mutate(
    treatment = recode(treatment, "CF_Asp_Neg" = "CF"),
    treatment = factor(treatment, levels = c("UNSTIM", "HC", "CF"))
  )

# Create density plots
p7 <- ggplot(abundance_by_treatment, aes(x = log10_fraction, fill = treatment)) +
  geom_density(alpha = 0.6, size = 1) +
  facet_wrap(~ treatment, ncol = 1) +
  labs(
    title = "Distribution Density of miRNA Abundances by Treatment",
    subtitle = "HC shows broader distributional tail; CF_Asp_Neg more similar to UNSTIM",
    x = "Log10(Fractional Abundance)",
    y = "Density",
    fill = "Treatment"
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11),
    strip.text = element_text(size = 12, face = "bold"),
    strip.background = element_rect(fill = "grey95", color = "grey50")
  ) +
  scale_fill_brewer(palette = "Set2")

print(p7)
save_figure(p7, "abundance_density_plots", width = 8, height = 10)

cat("\n\nKey observations from density plots:\n")
cat("- HC (Healthy Control): Broader, more extended tail → greater diversity/evenness\n")
cat("- UNSTIM: More concentrated distribution with shorter tail\n")
cat("- CF_Asp_Neg: Similar shape to UNSTIM, suggesting CF exposure produces\n")
cat("  a compositional structure more like unstimulated cells than HC-stimulated\n")
```

## 7.3 Empirical Cumulative Distribution Functions (ECDF)

This plot directly visualizes what the Kolmogorov-Smirnov test compares. Larger vertical gaps between curves indicate greater distributional differences.

```{r ecdf_plot, fig.width=10, fig.height=7}
# Create ECDF plot
p8 <- ggplot(abundance_by_treatment, aes(x = log10_fraction, color = treatment)) +
  stat_ecdf(size = 1.2, alpha = 0.8) +
  labs(
    title = "Empirical Cumulative Distribution Functions",
    subtitle = "Direct visualization of Kolmogorov-Smirnov test comparisons\nLarger gaps between curves = more significant differences",
    x = "Log10(Fractional Abundance)",
    y = "Cumulative Probability",
    color = "Treatment"
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11)
  ) +
  scale_color_brewer(palette = "Set2") +
  scale_y_continuous(labels = percent_format())

print(p8)
save_figure(p8, "ECDF_by_treatment", width = 10, height = 7)
```

## 7.4 Cumulative Abundance Curves

Shows how quickly each treatment reaches abundance thresholds. Steeper curves indicate more concentrated distributions where fewer miRNAs dominate.

```{r cumulative_curves, fig.width=10, fig.height=7}
# Create cumulative abundance curves
p9 <- ggplot(abundance_by_treatment, aes(x = rank, y = cumsum_pct, color = treatment)) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = c(50, 80, 90, 95), linetype = "dashed", alpha = 0.5) +
  scale_x_log10() +
  labs(
    title = "Cumulative Abundance Curves by Treatment",
    subtitle = "How many miRNAs needed to reach X% of total abundance",
    x = "Number of Top miRNAs (log scale)",
    y = "Cumulative % of Total Abundance",
    color = "Treatment"
  ) +
  theme_classic(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 14)
  ) +
  scale_color_brewer(palette = "Set2") +
  scale_y_continuous(labels = percent_format(scale = 1)) +
  annotate("text", x = 1000, y = c(50, 80, 90, 95), 
           label = c("50%", "80%", "90%", "95%"), 
           hjust = 1, alpha = 0.7, size = 3.5)

print(p9)
save_figure(p9, "cumulative_abundance_by_treatment", width = 10, height = 7)
```

---

# 8. Diversity Analysis

Ecological diversity metrics provide a complementary perspective on compositional differences. While Section 7 examined distributional shapes, this section quantifies how evenly miRNA reads are distributed across species using established diversity indices.

## 8.1 Calculate Diversity Metrics

```{r calculate_diversity}
# Function to calculate Gini coefficient (0 = perfect equality, 1 = complete inequality)
gini_coef <- function(x) {
  x <- sort(x[x > 0])
  n <- length(x)
  if(n == 0) return(NA)
  2 * sum((1:n) * x) / (n * sum(x)) - (n + 1) / n
}

# Calculate diversity metrics per sample
# Shannon entropy: H = -Σ(p * ln(p))
shannon_per_sample <- apply(frac_abundance, 2, function(x) {
  x <- x[x > 0]  # Remove zeros
  -sum(x * log(x))
})

# Simpson's diversity (1 - D): probability that two randomly selected reads are different miRNAs
simpson_per_sample <- apply(frac_abundance, 2, function(x) {
  1 - sum(x^2)
})

# Effective number of species (Hill number q=1): exponential of Shannon entropy
# Represents the "equivalent" number of equally-abundant miRNAs
effective_species <- exp(shannon_per_sample)

# Richness: number of detected miRNAs per sample
richness_per_sample <- apply(frac_abundance, 2, function(x) sum(x > 0))

# Pielou's evenness: J = H / H_max = H / ln(S)
# Ranges 0-1; higher = more even distribution
pielou_evenness <- shannon_per_sample / log(richness_per_sample)

# Gini coefficient per sample
gini_per_sample <- apply(frac_abundance, 2, gini_coef)

# Create comprehensive diversity data frame
diversity_df <- data.frame(
  Sample = names(shannon_per_sample),
  Shannon = shannon_per_sample,
  Simpson = simpson_per_sample,
  Effective_Species = effective_species,
  Richness = richness_per_sample,
  Pielou_Evenness = pielou_evenness,
  Gini = gini_per_sample,
  Treatment = sample_mapping[names(shannon_per_sample), "comparison_7"],
  row.names = NULL
)

# Set treatment factor levels
diversity_df$Treatment <- factor(diversity_df$Treatment, 
                                  levels = c("UNSTIM", "HC", "CF_Asp_Neg"))

# Display individual sample values
cat("\n=== Diversity Metrics by Sample ===\n\n")
print(diversity_df %>% arrange(Treatment, Sample), digits = 3)

# Save sample-level diversity data
write.csv(diversity_df, file.path(output_dir, "diversity_metrics_by_sample.csv"), 
          row.names = FALSE)
```

## 8.2 Summary Statistics by Treatment

```{r diversity_summary}
# Summary statistics by treatment
diversity_summary <- diversity_df %>%
  group_by(Treatment) %>%
  summarise(
    n = n(),
    Shannon_Mean = mean(Shannon),
    Shannon_SD = sd(Shannon),
    Simpson_Mean = mean(Simpson),
    Simpson_SD = sd(Simpson),
    Pielou_Mean = mean(Pielou_Evenness),
    Pielou_SD = sd(Pielou_Evenness),
    Effective_Species_Mean = mean(Effective_Species),
    Effective_Species_SD = sd(Effective_Species),
    Gini_Mean = mean(Gini),
    Gini_SD = sd(Gini),
    .groups = 'drop'
  )

cat("\n=== Diversity Metrics Summary by Treatment ===\n\n")
print(diversity_summary, digits = 3)

write.csv(diversity_summary, file.path(output_dir, "diversity_summary_by_treatment.csv"), 
          row.names = FALSE)

cat("\n\nInterpretation of diversity metrics:\n")
cat("- Shannon (H'): Higher values = more diverse/even distribution\n")
cat("- Simpson (1-D): Probability two random reads are different miRNAs (higher = more diverse)\n")
cat("- Pielou's J: Evenness relative to maximum possible (0-1 scale)\n")
cat("- Effective Species: Equivalent number of equally-abundant miRNAs\n")
cat("- Gini: Inequality coefficient (higher = more dominated by few miRNAs)\n")
```

## 8.3 Statistical Testing: ANOVA for Diversity Indices

```{r diversity_anova}
# ANOVA for Shannon diversity
cat("\n=== ANOVA: Shannon Diversity by Treatment ===\n")
shannon_aov <- aov(Shannon ~ Treatment, data = diversity_df)
print(summary(shannon_aov))

shannon_pval <- summary(shannon_aov)[[1]][["Pr(>F)"]][1]

if(shannon_pval < 0.05) {
  cat("\n=== Tukey HSD Post-hoc: Shannon Diversity ===\n")
  shannon_tukey <- TukeyHSD(shannon_aov)
  print(shannon_tukey)
}

# ANOVA for Simpson diversity
cat("\n=== ANOVA: Simpson Diversity by Treatment ===\n")
simpson_aov <- aov(Simpson ~ Treatment, data = diversity_df)
print(summary(simpson_aov))

simpson_pval <- summary(simpson_aov)[[1]][["Pr(>F)"]][1]

if(simpson_pval < 0.05) {
  cat("\n=== Tukey HSD Post-hoc: Simpson Diversity ===\n")
  simpson_tukey <- TukeyHSD(simpson_aov)
  print(simpson_tukey)
}

# ANOVA for Pielou's evenness
cat("\n=== ANOVA: Pielou's Evenness by Treatment ===\n")
pielou_aov <- aov(Pielou_Evenness ~ Treatment, data = diversity_df)
print(summary(pielou_aov))

pielou_pval <- summary(pielou_aov)[[1]][["Pr(>F)"]][1]

if(pielou_pval < 0.05) {
  cat("\n=== Tukey HSD Post-hoc: Pielou's Evenness ===\n")
  pielou_tukey <- TukeyHSD(pielou_aov)
  print(pielou_tukey)
}

# ANOVA for Gini coefficient
cat("\n=== ANOVA: Gini Coefficient by Treatment ===\n")
gini_aov <- aov(Gini ~ Treatment, data = diversity_df)
print(summary(gini_aov))

gini_pval <- summary(gini_aov)[[1]][["Pr(>F)"]][1]

if(gini_pval < 0.05) {
  cat("\n=== Tukey HSD Post-hoc: Gini Coefficient ===\n")
  gini_tukey <- TukeyHSD(gini_aov)
  print(gini_tukey)
}

# Summary of significance
cat("\n=== Summary of Diversity ANOVA Results ===\n")
diversity_anova_summary <- data.frame(
  Index = c("Shannon", "Simpson", "Pielou_Evenness", "Gini"),
  ANOVA_P_Value = c(shannon_pval, simpson_pval, pielou_pval, gini_pval),
  Significant = c(
    ifelse(shannon_pval < 0.05, "Yes", "No"),
    ifelse(simpson_pval < 0.05, "Yes", "No"),
    ifelse(pielou_pval < 0.05, "Yes", "No"),
    ifelse(gini_pval < 0.05, "Yes", "No")
  )
)
print(diversity_anova_summary, row.names = FALSE)

write.csv(diversity_anova_summary, file.path(output_dir, "diversity_ANOVA_results.csv"), 
          row.names = FALSE)
```

## 8.4 Visualization: Shannon Diversity

```{r shannon_plot, fig.width=8, fig.height=6}
# Create Shannon diversity boxplot
p_shannon <- ggplot(diversity_df, aes(x = Treatment, y = Shannon, fill = Treatment)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.7, size = 3) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, 
               fill = "red", color = "darkred") +
  scale_fill_brewer(palette = "Set2", labels = c("CF_Asp_Neg" = "CF")) +
  scale_x_discrete(labels = c("CF_Asp_Neg" = "CF")) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Shannon Diversity of miRNA Cargo by Treatment",
    subtitle = "Higher values indicate more even distribution across miRNA species\nRed diamonds = group means",
    x = "Treatment",
    y = "Shannon Diversity Index (H')"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    legend.position = "none"
  )

# Add significance annotation if ANOVA is significant
if(shannon_pval < 0.05) {
  # Get Tukey results for annotation
  tukey_df <- as.data.frame(shannon_tukey$Treatment)
  tukey_df$comparison <- rownames(tukey_df)
  sig_comparisons <- tukey_df[tukey_df$`p adj` < 0.05, ]
  
  if(nrow(sig_comparisons) > 0) {
    p_shannon <- p_shannon +
      annotate("text", x = 2, y = max(diversity_df$Shannon) + 0.1,
               label = sprintf("ANOVA p = %.4f", shannon_pval),
               size = 3.5, fontface = "italic")
  }
}

print(p_shannon)
save_figure(p_shannon, "shannon_diversity_by_treatment", width = 8, height = 6)
```

## 8.5 Visualization: Multi-Panel Diversity Metrics

```{r diversity_panel, fig.width=14, fig.height=5}
# Reshape for faceted plot
diversity_long <- diversity_df %>%
  dplyr::select(Sample, Treatment, Shannon, Simpson, Pielou_Evenness, Gini) %>%
  pivot_longer(cols = c(Shannon, Simpson, Pielou_Evenness, Gini), 
               names_to = "Index", values_to = "Value") %>%
  mutate(Index = factor(Index, 
                        levels = c("Shannon", "Simpson", "Pielou_Evenness", "Gini"),
                        labels = c("Shannon (H')", "Simpson (1-D)", 
                                   "Pielou Evenness (J)", "Gini Coefficient")))

# Create multi-panel plot
p_diversity_panel <- ggplot(diversity_long, aes(x = Treatment, y = Value, fill = Treatment)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.6, size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, 
               fill = "red", color = "darkred") +
  facet_wrap(~ Index, scales = "free_y", ncol = 4) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Diversity and Evenness Metrics by Treatment",
    subtitle = "Multiple indices capture different aspects of compositional diversity | Red diamonds = group means",
    x = "Treatment",
    y = "Index Value"
  ) +
  theme_bw(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    strip.text = element_text(face = "bold", size = 11),
    strip.background = element_rect(fill = "grey95"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

print(p_diversity_panel)
save_figure(p_diversity_panel, "diversity_panel_by_treatment", width = 14, height = 5)
```

## 8.6 Effective Number of Species

The effective number of species (Hill number q=1) provides an intuitive interpretation: how many equally-abundant miRNAs would produce the same Shannon diversity?

```{r effective_species_plot, fig.width=8, fig.height=6}
# Create effective species boxplot
p_effective <- ggplot(diversity_df, aes(x = Treatment, y = Effective_Species, fill = Treatment)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA, width = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.7, size = 3) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, 
               fill = "red", color = "darkred") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Effective Number of miRNA Species by Treatment",
    subtitle = "Equivalent number of equally-abundant miRNAs (exp of Shannon entropy)",
    x = "Treatment",
    y = "Effective Number of Species"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    legend.position = "none"
  )

print(p_effective)
save_figure(p_effective, "effective_species_by_treatment", width = 8, height = 6)

# Report means
cat("\n=== Effective Number of Species by Treatment ===\n")
diversity_df %>%
  group_by(Treatment) %>%
  summarise(
    Mean = mean(Effective_Species),
    SD = sd(Effective_Species),
    Median = median(Effective_Species),
    .groups = 'drop'
  ) %>%
  print(digits = 2)
```

## 8.7 Rank-Abundance Curves (Whittaker Plots)

Rank-abundance curves show how steeply abundance drops off with rank. Steeper curves indicate communities more dominated by a few species; flatter curves indicate more even distributions.

```{r rank_abundance, fig.width=10, fig.height=7}
# Calculate mean fractional abundance per miRNA for each treatment
rank_abundance_data <- frac_abundance %>%
  as.data.frame() %>%
  mutate(miRNA = rownames(.)) %>%
  pivot_longer(-miRNA, names_to = "Sample", values_to = "Fraction") %>%
  mutate(Treatment = sample_mapping[Sample, "comparison_7"]) %>%
  group_by(Treatment, miRNA) %>%
  summarise(Mean_Fraction = mean(Fraction), .groups = "drop") %>%
  group_by(Treatment) %>%
  arrange(desc(Mean_Fraction)) %>%
  mutate(Rank = row_number()) %>%
  ungroup() %>%
  mutate(Treatment = factor(Treatment, levels = c("UNSTIM", "HC", "CF_Asp_Neg")))

# Create rank-abundance plot
p_rank_abundance <- ggplot(rank_abundance_data, 
                           aes(x = Rank, y = Mean_Fraction, color = Treatment)) +
  geom_line(size = 1, alpha = 0.8) +
  scale_y_log10(labels = percent_format(accuracy = 0.01)) +
  scale_x_log10() +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Rank-Abundance Curves by Treatment",
    subtitle = "Steeper curves indicate more uneven distributions dominated by few miRNAs",
    x = "Rank (log scale)",
    y = "Mean Fractional Abundance (log scale)",
    color = "Treatment"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom"
  )

print(p_rank_abundance)
save_figure(p_rank_abundance, "rank_abundance_curves", width = 10, height = 7)
```

## 8.8 Rank-Abundance Curves (Top 100 miRNAs)

```{r rank_abundance_zoom, fig.width=10, fig.height=7}
# Zoom to top 100 miRNAs
p_rank_abundance_zoom <- ggplot(rank_abundance_data %>% filter(Rank <= 100), 
                                aes(x = Rank, y = Mean_Fraction, color = Treatment)) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_point(size = 1.5, alpha = 0.6) +
  scale_y_log10(labels = percent_format(accuracy = 0.01)) +
  scale_color_brewer(palette = "Set2") +
  labs(
    title = "Rank-Abundance Curves: Top 100 miRNAs",
    subtitle = "Focused view of most abundant miRNAs across treatment groups",
    x = "Rank",
    y = "Mean Fractional Abundance (log scale)",
    color = "Treatment"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    legend.position = "bottom"
  )

print(p_rank_abundance_zoom)
save_figure(p_rank_abundance_zoom, "rank_abundance_curves_top100", width = 10, height = 7)
```

## 8.8 Diversity Interpretation Summary

```{r diversity_interpretation}
cat("\n")
cat("================================================================================\n")
cat("                    DIVERSITY ANALYSIS INTERPRETATION                           \n")
cat("================================================================================\n\n")

# Calculate and report key findings
diversity_means <- diversity_df %>%
  group_by(Treatment) %>%
  summarise(
    Shannon = mean(Shannon),
    Pielou = mean(Pielou_Evenness),
    Gini = mean(Gini),
    Effective = mean(Effective_Species),
    .groups = 'drop'
  )

cat("KEY FINDINGS:\n\n")

cat("1. Shannon Diversity (H'):\n")
for(i in 1:nrow(diversity_means)) {
  cat(sprintf("   %s: %.3f\n", diversity_means$Treatment[i], diversity_means$Shannon[i]))
}
cat(sprintf("   Order: %s\n\n", 
            paste(diversity_means$Treatment[order(diversity_means$Shannon, decreasing = TRUE)], 
                  collapse = " > ")))

cat("2. Pielou's Evenness (J):\n")
for(i in 1:nrow(diversity_means)) {
  cat(sprintf("   %s: %.3f\n", diversity_means$Treatment[i], diversity_means$Pielou[i]))
}
cat(sprintf("   Order: %s\n\n", 
            paste(diversity_means$Treatment[order(diversity_means$Pielou, decreasing = TRUE)], 
                  collapse = " > ")))

cat("3. Gini Coefficient (inequality):\n")
for(i in 1:nrow(diversity_means)) {
  cat(sprintf("   %s: %.3f\n", diversity_means$Treatment[i], diversity_means$Gini[i]))
}
cat(sprintf("   Order (most to least concentrated): %s\n\n", 
            paste(diversity_means$Treatment[order(diversity_means$Gini, decreasing = TRUE)], 
                  collapse = " > ")))

cat("4. Effective Number of Species:\n")
for(i in 1:nrow(diversity_means)) {
  cat(sprintf("   %s: %.1f miRNAs\n", diversity_means$Treatment[i], diversity_means$Effective[i]))
}

cat("\n--------------------------------------------------------------------------------\n")
cat("BIOLOGICAL INTERPRETATION:\n\n")

# Determine the pattern
if(diversity_means$Shannon[diversity_means$Treatment == "HC"] > 
   diversity_means$Shannon[diversity_means$Treatment == "CF_Asp_Neg"] &&
   diversity_means$Shannon[diversity_means$Treatment == "CF_Asp_Neg"] > 
   diversity_means$Shannon[diversity_means$Treatment == "UNSTIM"]) {
  
  cat("The pattern HC > CF > UNSTIM for miRNA diversity suggests:\n\n")
  cat("• Exposure to bronchoalveolar lavage stimulates HMSCs to diversify their\n")
  cat("  EV-associated miRNA cargo beyond the baseline (UNSTIM) state.\n\n")
  cat("• Healthy BAL induces the GREATEST diversification, suggesting that healthy\n")
  cat("  lung signals trigger a broad, complex cellular response in HMSCs.\n\n")
  cat("• CF BAL produces an ATTENUATED diversification response—miRNA cargo\n")
  cat("  becomes more diverse than unstimulated cells but less diverse than\n")
  cat("  healthy BAL-exposed cells.\n\n")
  cat("• This 'diversity deficit' in CF-exposed EVs may reflect:\n")
  cat("  (a) Impaired HMSC responsiveness to disease-associated signals\n")
  cat("  (b) A fundamentally different signaling landscape in CF lungs that fails\n")
  cat("      to trigger full cargo diversification\n")
  cat("  (c) Presence of inhibitory factors in CF BAL that constrain EV loading\n\n")
  cat("• THERAPEUTIC IMPLICATION: If therapeutic efficacy requires diverse miRNA\n")
  cat("  cargo for pleiotropic effects, CF-conditioned EVs may be less effective\n")
  cat("  not because they lack specific miRNAs, but because they lack\n")
  cat("  compositional complexity.\n")
  
} else {
  cat("The observed diversity pattern differs from the expected HC > CF > UNSTIM.\n")
  cat("Please examine the summary statistics above to interpret the biological\n")
  cat("significance of the observed pattern.\n")
}

cat("\n================================================================================\n")
```

---

# 9. Export Data for Further Analysis

```{r export_data}
# Export fractional abundance for major miRNAs
major_frac_export <- frac_abundance[major_mirna_names, ] %>%
  as.data.frame() %>%
  mutate(miRNA = rownames(.)) %>%
  dplyr::select(miRNA, everything())

write.csv(major_frac_export, file.path(output_dir, "major_miRNAs_fractional_abundances.csv"), 
          row.names = FALSE)

# Export all fractional abundances (sorted by mean)
all_frac_export <- frac_abundance %>%
  as.data.frame() %>%
  mutate(
    miRNA = rownames(.),
    Mean_Fraction = rowMeans(.)
  ) %>%
  arrange(desc(Mean_Fraction)) %>%
  dplyr::select(miRNA, Mean_Fraction, everything())

write.csv(all_frac_export, file.path(output_dir, "all_miRNA_fractional_abundances.csv"), 
          row.names = FALSE)

cat("\n=== Data Files Exported ===\n\n")
cat("Compositional Analysis:\n")
cat("  1. major_miRNAs_1pct_summary.csv\n")
cat("  2. major_miRNAs_fractional_abundances.csv\n")
cat("  3. all_miRNA_fractional_abundances.csv\n")
cat("  4. major_miRNAs_ANOVA_results.csv\n")
cat("  5. major_miRNAs_posthoc_comparisons.csv (if significant differences found)\n")
cat("  6. major_miRNAs_treatment_summary.csv\n")
cat("  7. KS_test_results.csv\n\n")

cat("Diversity Analysis:\n")
cat("  8. diversity_metrics_by_sample.csv\n")
cat("  9. diversity_summary_by_treatment.csv\n")
cat(" 10. diversity_ANOVA_results.csv\n\n")

cat("=== Figures Created ===\n\n")
cat("Compositional Visualizations:\n")
cat("  1.  major_miRNAs_barplot.png/.pdf\n")
cat("  2.  cumulative_abundance_plot.png/.pdf\n")
cat("  3.  composition_stacked_bar.png/.pdf\n")
cat("  4.  major_miRNAs_heatmap_by_sample.png/.pdf\n")
cat("  5.  major_miRNAs_boxplot_by_group.png/.pdf\n")
cat("  6.  major_miRNAs_significant_differences.png/.pdf (if significant)\n")
cat("  7.  major_miRNAs_stacked_by_sample.png/.pdf\n")
cat("  8.  abundance_density_plots.png/.pdf\n")
cat("  9.  ECDF_by_treatment.png/.pdf\n")
cat(" 10.  cumulative_abundance_by_treatment.png/.pdf\n\n")

cat("Diversity Visualizations:\n")
cat(" 11.  shannon_diversity_by_treatment.png/.pdf\n")
cat(" 12.  diversity_panel_by_treatment.png/.pdf\n")
cat(" 13.  effective_species_by_treatment.png/.pdf\n")
cat(" 14.  rank_abundance_curves.png/.pdf\n")
cat(" 15.  rank_abundance_curves_top100.png/.pdf\n")

cat("\n=== All outputs saved to: ===\n")
cat(output_dir, "\n")
```

---

# 10. Session Information

```{r session_info}
sessionInfo()
```

---

# Summary

This compositional and diversity analysis demonstrates that:

1. **`r n_major` miRNAs individually account for ≥1% of total reads**, collectively representing **`r sprintf("%.1f%%", total_major_fraction * 100)`** of all miRNA reads in extracellular vesicles from hMSCs.

2. The most abundant miRNA is **`r major_mirna_names[1]`**, representing `r sprintf("%.2f%%", major_mirnas_sorted[1] * 100)` of total reads.

3. The remaining `r n_total - n_major` detected miRNAs collectively represent only `r sprintf("%.1f%%", remaining_fraction * 100)` of total reads.

4. This highly skewed distribution is typical of miRNA populations in extracellular vesicles, where a small number of miRNAs dominate the cargo.

5. The stacked bar plot (Section 6.6) shows compositional consistency within treatment groups and reveals compositional differences between groups at the individual sample level.

6. **Statistical testing reveals which major miRNAs differ between treatment groups** (Section 6.3):
   - One-way ANOVA tests performed for each of the 13 major miRNAs
   - Bonferroni correction applied to control for multiple testing
   - Post-hoc pairwise comparisons (Tukey HSD) identify specific group differences
   - Results show which miRNAs are differentially abundant in response to treatment conditions

7. **Treatment groups show significantly different compositional structures** (Section 7):
   - All pairwise Kolmogorov-Smirnov tests are highly significant (p < 0.05)
   - HC (healthy control BAL) exhibits a broader distributional tail, suggesting greater compositional diversity
   - CF_Asp_Neg (CF BAL exposed) is compositionally more similar to UNSTIM than to HC
   - These differences indicate that exposure conditions fundamentally alter miRNA cargo composition

8. **Diversity analysis provides quantitative metrics for compositional complexity** (Section 8):
   - Shannon diversity, Simpson's diversity, Pielou's evenness, and Gini coefficient calculated per sample
   - Rank-abundance curves visualize the steepness of species abundance decay
   - Effective number of species provides intuitive interpretation of diversity values
   - Statistical testing (ANOVA with Tukey HSD) identifies significant treatment effects on diversity

9. The analysis identifies not only which specific miRNAs are most abundant, but also which show treatment-dependent changes, providing insight into both the stable "core" miRNA cargo and the treatment-responsive miRNA components in hMSC-derived EVs.

10. **Diversity metrics suggest BAL exposure promotes miRNA cargo diversification**, with healthy BAL inducing greater diversity than CF BAL. This "diversity deficit" in CF-exposed EVs may have therapeutic implications if compositional complexity is required for pleiotropic effects.

The visualizations and data tables provide multiple perspectives on compositional structure, focusing on biologically relevant miRNAs that individually contribute ≥1% to the total miRNA population in hMSC-derived extracellular vesicles under different exposure conditions.
